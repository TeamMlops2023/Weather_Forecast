pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                script {
                    sh 'docker build -t fastapi-image ./fastapi'
                    echo 'Construction de l\'image Docker réussie.'
                }
            }
        }
        stage('Run') {
            steps {
                script {
                    sh 'docker run -d --name fastapi-container -p 8000:8000 fastapi-image'
                    echo 'Lancement du conteneur réussi.'
                }
            }
        }
        stage('Test') {
            steps {
                script {
                    sh 'sleep 10' // Attente pour que le serveur démarre
                    echo 'Affichage des réponses des endpoints pour débogage :'
                    sh 'curl -s http://localhost:8000/'
                    sh 'curl -s http://localhost:8000/status'
                    sh 'curl -s "http://localhost:8000/echo?text=HelloJenkins"'
                }
            }
        }
        // La stage de Cleanup est désactivée pour le débogage
        // stage('Cleanup') {
        //     steps {
        //         script {
        //             sh 'docker stop fastapi-container || true'
        //             sh 'docker rm fastapi-container || true'
        //             echo 'Nettoyage du conteneur réussi.'
        //         }
        //     }
        // }
    }

    post {
        always {
            echo 'Pipeline terminé. Vérifiez les logs pour les détails.'
        }
    }
}
