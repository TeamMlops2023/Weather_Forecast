pipeline {
    agent any

    environment {
        KUBECONFIG = '/var/jenkins_home/.kube/config'
    }

    stages {
        stage('Initialisation') {
            steps {
                script {
                    // Ajout des dépôts Helm
                    sh 'helm repo add prometheus-community https://prometheus-community.github.io/helm-charts'
                    sh 'helm repo add grafana https://grafana.github.io/helm-charts'
                    sh 'helm repo update'
                }
            }
        }
        stage('Déployer Prometheus') {
            steps {
                script {
                    // Déploiement de Prometheus avec le fichier values.yaml personnalisé
                    sh 'helm upgrade --install prometheus prometheus-community/prometheus -f ./monitoring/values.yaml --namespace monitoring --create-namespace'
                }
            }
        }
        stage('Déployer Grafana') {
            steps {
                script {
                    // Déploiement de Grafana avec le fichier grafana-values.yaml personnalisé
                    sh 'helm upgrade --install grafana grafana/grafana -f ./monitoring/grafana-values.yaml --namespace monitoring --create-namespace'
                }
            }
        }
        stage('Vérification') {
            steps {
                script {
                    // Vérifier l'état des pods dans le namespace monitoring
                    sh 'kubectl get pods -n monitoring'
                }
            }
        }
    }
}
