pipeline {
    agent any

    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    // Construire l'image Docker à partir du Dockerfile dans le répertoire machine_learning
                    mlContainer = docker.build('ml-model-image', './machine_learning')
                }
            }
        }

        stage('Run Container and Test') {
            steps {
                script {
                    // Démarrer le conteneur Docker pour les tests
                    sh 'docker run -d --name ml-test-container ml-model-image'
                    sh 'sleep 10' // Laisser un peu de temps pour le démarrage du conteneur

                    // Exécuter les tests unitaires à l'intérieur du conteneur Docker
                    sh 'docker exec ml-test-container python -m unittest discover -s tests'
                }
            }
        }

        stage('Cleanup') {
            steps {
                script {
                    // Nettoyage : arrêter et supprimer le conteneur de test
                    sh 'docker stop ml-test-container || true'
                    sh 'docker rm ml-test-container || true'
                }
            }
        }
    }
}
